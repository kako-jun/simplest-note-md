## 編集/プレビュー間のスクロール同期

### 概要

2ペイン表示で同じリーフを左右に開いている場合（一方が編集モード、他方がプレビューモード）、スクロール位置が双方向に自動同期されます。これにより、長いマークダウン文書の特定箇所を編集しながらプレビューを確認する作業が効率化されます。

### 動作条件

スクロール同期は以下の条件をすべて満たす場合にのみ有効になります：

1. **2ペイン表示**: 画面アスペクト比が横>縦（`isDualPane === true`）
2. **同じリーフ**: 左右のペインで同じリーフID（`$currentLeaf.id === rightLeaf.id`）
3. **片方が編集、もう片方がプレビュー**:
   - 左が`edit`、右が`preview`
   - または左が`preview`、右が`edit`

### 技術実装

#### コンポーネント構成

スクロール同期は4つのコンポーネントで実装されています：

| コンポーネント        | 役割                           |
| --------------------- | ------------------------------ |
| MarkdownEditor.svelte | CodeMirrorのスクロール制御     |
| PreviewView.svelte    | プレビューのスクロール制御     |
| EditorView.svelte     | スクロールイベントのパススルー |
| App.svelte            | 左右ペイン間の同期ロジック     |

各コンポーネントは以下のインターフェースを公開します：

- **onScroll**: スクロールイベントを親に通知するコールバック
- **scrollTo(scrollTop)**: 外部からスクロール位置を設定するメソッド

#### 双方向同期ロジック

App.svelteで左右ペインのスクロールイベントを監視し、同期条件を満たす場合にもう一方のペインの`scrollTo()`を呼び出します。

### 無限ループ防止

#### 問題

スクロール同期では以下のような無限ループが発生する可能性があります：

1. 左ペインでスクロール → `handleLeftScroll`が発火
2. 右ペインの`scrollTo()`を呼び出し → 右ペインがスクロール
3. 右ペインのスクロールイベント発火 → `handleRightScroll`が発火
4. 左ペインの`scrollTo()`を呼び出し → 左ペインがスクロール
5. 1に戻る（無限ループ）

#### 解決策

各コンポーネントで`isScrollingSynced`フラグを使用し、外部からの`scrollTo()`呼び出し中はスクロールイベントを無視します。`setTimeout(..., 0)`でスクロール処理完了後にフラグをリセットします。

### 双方向性

スクロール同期は完全に双方向です：

- **左→右**: 左ペインをスクロール → 右ペインが追従
- **右→左**: 右ペインをスクロール → 左ペインが追従

どちらのペインからでも自由にスクロールでき、もう一方のペインが自動的に追従します。

### 使用例

#### 長いマークダウンを編集

```
┌─────────────────────┬─────────────────────┐
│ 左ペイン（編集）     │ 右ペイン（プレビュー）│
│                     │                     │
│ # 見出し1           │  見出し1            │
│ 本文...             │  本文...            │
│                     │                     │
│ ## 見出し2          │  見出し2            │
│ ここを編集中 ←──────│→ プレビューも       │
│                     │   自動スクロール    │
│ ## 見出し3          │  見出し3            │
│ ...                 │  ...                │
└─────────────────────┴─────────────────────┘
```

#### 片方がhome/note画面の場合

スクロール同期は無効です。左右両方が同じリーフを表示している必要があります。

```
┌─────────────────────┬─────────────────────┐
│ 左ペイン（home）     │ 右ペイン（編集）     │
│                     │                     │
│ ノート一覧          │  # リーフ1          │
│ - ノート1           │  本文...            │
│ - ノート2           │                     │
│                     │  ← スクロール同期   │
│                     │     されない        │
└─────────────────────┴─────────────────────┘
```

#### 違うリーフを表示している場合

スクロール同期は無効です。同じリーフIDである必要があります。

```
┌─────────────────────┬─────────────────────┐
│ 左ペイン（リーフA）  │ 右ペイン（リーフB）  │
│                     │                     │
│ # リーフA           │  # リーフB          │
│ 本文A...            │  本文B...           │
│                     │                     │
│ ← スクロール同期    │                     │
│    されない         │                     │
└─────────────────────┴─────────────────────┘
```

### 動作フロー

1. **2ペイン表示**: 画面を横長にする（スマホを横向き、またはPC画面）
2. **同じリーフを左右で開く**: 左ペインでリーフを選択 → 右ペインでも同じリーフを選択
3. **片方をプレビューに切り替え**: 右ペインのプレビューボタンをクリック
4. **スクロール**: 左ペイン（編集）をスクロール → 右ペイン（プレビュー）が自動追従
5. **逆方向も同様**: 右ペイン（プレビュー）をスクロール → 左ペイン（編集）が自動追従

---
