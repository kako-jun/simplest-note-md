# 拡張計画と既知の課題

Agasteerの将来的な拡張計画と既知の課題について説明します。

## 拡張の可能性

### 短期的な改善提案

1. **~~エクスポート/インポート機能~~** ✅ **完了**
   - ✅ ZIP形式でのエクスポート
   - ✅ Agasteer形式のインポート
   - ✅ SimpleNote形式からのインポート

2. **~~検索機能~~** ✅ **完了（基本機能）**
   - ✅ ノート名・リーフ名での検索
   - ✅ 全文検索（content内）
   - [ ] 正規表現対応（未実装）

3. **~~キーボードショートカット~~** ✅ **完了（一部）**
   - ✅ `Ctrl+S`: GitHub保存
   - [ ] `Ctrl+N`: 新規ノート（未実装）
   - [ ] `Ctrl+K`: クイック検索（未実装）

4. **~~オフライン対応~~** ✅ **完了（PWA対応として実装）**
   - ✅ Service Workerでのキャッシュ（静的アセット、GitHub API）
   - ⚠️ オフライン時の同期キュー（未実装：初回Pullが必須のため完全オフラインは非対応）

### 中期的な機能提案

1. **GitHub双方向同期**
   - GitHub→アプリの自動取得
   - 競合解決UI
   - 差分表示

2. **Markdown拡張**
   - タスクリスト（`- [ ]` / `- [x]`）
   - 数式サポート（KaTeX）
   - Mermaid図表対応

3. **タグシステム**
   - ノートへのタグ付け
   - タグでのフィルタリング
   - タグクラウド表示

4. **履歴管理**
   - ノート編集履歴の保存
   - 差分表示
   - 過去バージョンへの復元

5. **~~モバイル最適化~~** ✅ **完了**
   - ✅ スワイプジェスチャー
   - ✅ タッチ操作の改善
   - ✅ PWA対応

### 長期的なビジョン

1. **プラグインシステム**
   - カスタムコマンドの登録
   - エディタ拡張
   - テーマのプラグイン化

2. **他サービスとの連携**
   - GitLab API対応
   - Dropbox/OneDrive同期
   - WebDAV対応

3. **コラボレーション**
   - 共有リンク生成
   - リアルタイム共同編集（WebSocket）
   - コメント機能

4. **AI統合**
   - 文章校正
   - 自動要約
   - ノートの分類提案

---

## 既知の課題

### ~~メタデータの永続化問題~~ ✅ **解決済み（Version 4.3）**

**問題の内容:**

以前は、GitHubには**リーフのMarkdownファイルのみ**が保存されており、以下のメタデータが失われていました：

1. **ノート・リーフのID**
   - Pull時に新しいUUIDが割り当てられる
   - URLのクエリパラメータが無効になる
   - ブックマークやディープリンクが機能しない

2. **並び順（order）**
   - ユーザーがドラッグ&ドロップで並び替えても、Pull後に順序が失われる
   - ファイルシステムのアルファベット順で表示されてしまう

3. **ノート・リーフの親子関係**
   - ディレクトリ構造から推測するため、ノート名変更時に対応が難しい

**解決策（Version 4.3で実装）:**

`notes/metadata.json` を導入し、以下のメタ情報を永続化：

| フィールド | 型     | 説明                                        |
| ---------- | ------ | ------------------------------------------- |
| version    | number | メタデータバージョン（現在は1）             |
| pushCount  | number | Push回数（統計情報）                        |
| notes      | object | ノート情報（パス → {id, order}）            |
| leaves     | object | リーフ情報（パス → {id, updatedAt, order}） |

**効果:**

- ✅ Pull後も並び順が保持される
- ✅ URLからの復元が正しく機能する
- ✅ ブックマークやディープリンクが永続的に有効
- ✅ Push回数などの統計情報も保存可能

### その他の既知の制約

1. **複数デバイスでの同時編集**
   - Last Write Winsの仕様（最後にPushしたデバイスが勝つ）
   - マージ機能なし

2. **Push失敗後のPullでデータ消失**
   - 仕様通りの動作だが、ユーザーにとって直感的でない可能性

3. **ネットワークエラー時の挙動**
   - Push失敗時、編集内容はIndexedDBに残るが、次のPullで消える
   - オフライン対応なし

4. **Gboard（Android）での空行タップ時のスクロールジャンプ**
   - Android端末でGboardを使用している場合、空行をタップするとスクロール位置が意図しない場所にジャンプする
   - GboardがCodeMirrorのフォーカス処理に介入することで発生
   - CodeMirror側での修正は困難（キーボードを非表示にすると問題は発生しないことを確認済み）
   - **回避策**: 空行をタップする代わりに、テキストがある行をタップしてからカーソルを移動する
   - 関連: `highlightActiveLine()`は段落をまたぐ範囲選択で問題を起こすため除外済み（[features.md参照](./features.md#モバイル互換性)）

---

## 実装完了済み（2026-01時点）

### URLルーティングとペイン表示 ✅ 完了

#### 現状の課題

現在はクエリパラメータベースのURL（`?note=uuid&leaf=uuid`）を使用していますが、以下の問題があります：

1. **UUIDの不安定性**
   - Pull時に新しいUUIDが割り当てられるため、ブックマークやディープリンクが無効になる
   - GitHubにメタデータを保存していないため、IDが永続化されない

2. **URL の可読性**
   - UUIDはユーザーにとって意味のない文字列
   - URLから内容を推測できない

3. **2ペイン表示への対応不足**
   - 横長画面では2ペイン表示を実現したい（左右で別々のノート・リーフを表示）
   - 現在のURL設計では2つの状態を表現できない

#### 新しい設計方針

**2ペイン対応のクエリパラメータ設計**に移行し、ノート名・リーフ名のパスをURLに使用する：

| 形式   | URL例                                      |
| ------ | ------------------------------------------ |
| 現在   | `?note={UUID}&leaf={UUID}`                 |
| 新設計 | `?left=/仕事/会議&right=/仕事/会議/議事録` |

#### UI設計

**横長画面での2ペイン表示**:

```
┌─────────────────────────────────────────────────┐
│ Header                                          │
├─────────────────────────────────────────────────┤
│ Breadcrumbs (共通)                              │
├────────────────────┬────────────────────────────┤
│ Left Pane          │ Right Pane                 │
│                    │                            │
│ ノート・リーフ一覧  │ リーフ編集画面             │
│ (左側パス)          │ (右側パス)                 │
│                    │                            │
└────────────────────┴────────────────────────────┘
```

- パンくずリストより下が左右2つに分割
- 左右それぞれ独立して操作可能
- 縦長画面では1ペイン表示（従来通り）

#### 実装方針

1. **ファイル名の一意性制約**
   - 同じ階層に同じ名前のノート・リーフを作成できないようにする
   - 作成時にバリデーションを追加

2. **URLエンコーディング**
   - 日本語や特殊文字を含むパスをURLエンコード
   - `encodeURIComponent()` / `decodeURIComponent()` を使用

3. **パス解析**
   - クエリパラメータ `left` と `right` からパスを抽出
   - パス文字列（`/ノート名/サブノート名/リーフ名`）からノート・リーフを解決

4. **レスポンシブ対応**
   - URLは常に `left` と `right` の両方を持つ
   - 縦長画面では右ペインをCSSで非表示にするだけ
   - URLの構造は画面サイズに関わらず同じ

5. **ハッシュの使用禁止**
   - SPAルーティングでよく使われる `#` は使用しない
   - History APIを活用

#### URL例

| URL                                   | 説明                                   |
| ------------------------------------- | -------------------------------------- |
| `?left=/仕事&right=/仕事/会議/議事録` | 左:仕事ノート一覧、右:議事録編集       |
| `?left=/仕事/会議&right=/仕事/その他` | 左:会議サブノート、右:その他サブノート |

縦長画面では右ペインがCSSで非表示になるだけで、URLは同じ。画面を回転させれば右ペインが見えるようになる。

#### メリット

- ✅ **URLの永続性**: Pull後もノート名・リーフ名が変わらなければURLは有効
- ✅ **可読性**: URLから内容が推測できる
- ✅ **2ペイン対応**: 左右の状態を同時に保存・復元可能
- ✅ **ブックマーク対応**: 作業状態をそのままブックマーク
- ✅ **GitHubとの整合性**: パスがGitHubのディレクトリ構造と一致

#### 実装タスク（全て完了）

- [x] ノート・リーフ作成時の名前重複チェック（同一階層）
- [x] URLクエリパース処理の実装（`left` / `right`）
- [x] パス文字列からノート・リーフを解決するロジック
- [x] 2ペイン表示のレイアウト実装（CSS Grid）
- [x] レスポンシブ対応（画面幅による1ペイン/2ペイン切り替え）
- [x] ブラウザ履歴の管理
- [x] エラーハンドリング（存在しないパスへのアクセス）

**実装された機能:**

- 横長画面で自動的に2ペイン表示
- 左右独立したナビゲーション
- URLにleft/rightパラメータを使用
- ペイン操作メニュー（左右入れ替え、片方を閉じる等）
