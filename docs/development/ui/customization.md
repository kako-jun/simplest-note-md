## カスタムフォント機能

### 概要

ユーザーが自由にフォントファイルをアップロードして、アプリ全体のフォントを変更できる機能。サーバー側にフォントを持たず、完全にクライアントサイド（IndexedDB）で保存・管理する。

### 技術実装

1. **フォントの読み込み**: FileReader APIでArrayBufferとして読み込み
2. **保存**: IndexedDBの`fonts`ストアに保存
3. **適用**: Blob URLを作成し、`@font-face`でCSS変数に設定
4. **削除**: スタイル要素を削除するとデフォルトCSSに戻る

### UI/UX

#### 設定画面のUI要素

- **「フォント選択」ボタン**: ファイル選択ダイアログを開く
- **「デフォルトに戻す」ボタン**: カスタムフォントを削除（確認なし）
- **対応フォーマット表示**: `.ttf`, `.otf`, `.woff`, `.woff2`
- **アップロード状態表示**: アップロード中は「アップロード中...」と表示

#### 操作フロー

1. 設定画面を開く
2. 「フォント選択」ボタンをクリック
3. フォントファイルを選択
4. **即座に適用**（リロード不要）
5. 「デフォルトに戻す」で元に戻す（リロード不要）

### 仕様

- **同時保存数**: 1つのみ（新しいフォントは自動で上書き）
- **保存場所**: IndexedDB `fonts` オブジェクトストア
- **設定フラグ**: `Settings.hasCustomFont` (boolean) をLocalStorageに保存
- **適用範囲**: body, input, textarea, button, CodeMirrorエディタ
- **リロード**: 適用・削除ともにリロード不要
- **起動時復元**: `hasCustomFont`フラグがtrueの場合、自動で適用

### セキュリティ

- **拡張子チェック**: `.ttf`, `.otf`, `.woff`, `.woff2` のみ許可
- **Blobベース読み込み**: `URL.createObjectURL()`で安全に適用
- **クライアントサイド完結**: サーバーにフォントファイルをアップロードしない

---

## システム等幅Webフォント

### 概要

エディタとcodeブロックに日本語CJK等幅フォント（BIZ UDGothic）を自動適用する機能。Linux環境など、ローカルに日本語等幅フォントがインストールされていない場合でも、美しい表示を実現します。

### 設計思想

| 機能                        | 適用範囲                                     | ユーザー操作     |
| --------------------------- | -------------------------------------------- | ---------------- |
| **システム等幅Webフォント** | エディタ + codeブロックのみ（`--font-mono`） | 自動（設定不要） |
| **カスタムフォント**        | アプリ全体（body, input, etc.）              | 手動アップロード |

カスタムフォントがアップロードされている場合は、カスタムフォントが優先されます。

### 技術実装

1. **ダウンロード**: Google Fonts CSSからwoff2 URLを抽出してダウンロード
2. **キャッシュ**: IndexedDBの`fonts`ストア（キー: `system-mono`）に保存
3. **適用**: `--font-mono` CSS変数に設定

### 起動時の処理フロー

```
アプリ起動
    ↓
loadAndApplySystemMonoFont()
    ↓
IndexedDBに 'system-mono' キーで検索
    ↓
┌─ キャッシュあり & バージョン一致
│      ↓
│   IndexedDBから読み込んで適用
│
└─ キャッシュなし or バージョン不一致
       ↓
    Google Fontsからダウンロード
       ↓
    IndexedDBに保存
       ↓
    適用
```

### バージョン管理

`SYSTEM_MONO_FONT_VERSION`定数でバージョンを管理。フォントを変更する場合はバージョンを上げるだけで、全ユーザーに新しいフォントが配信されます。

### 優先順位

エディタ部分のフォント適用優先順位：

1. **カスタムフォント**（`!important`で全体に適用）
2. **システム等幅Webフォント**（`--font-mono`に適用）
3. **CSSフォールバック**（`'Courier New', Menlo, Consolas, monospace`）

### 仕様

| 項目           | 内容                                                      |
| -------------- | --------------------------------------------------------- |
| **フォント**   | BIZ UDGothic（Google Fonts）                              |
| **サイズ**     | 約1.2MB（woff2圧縮）                                      |
| **保存場所**   | IndexedDB `fonts` ストア（キー: `system-mono`）           |
| **適用範囲**   | `--font-mono` CSS変数のみ                                 |
| **PWA対応**    | バージョンアップ時も再ダウンロード不要（IndexedDBは永続） |
| **オフライン** | キャッシュ済みなら動作可能                                |
| **エラー時**   | CSSフォールバックが使用される                             |

### メリット

- **ユーザー設定不要**: 初回起動時に自動ダウンロード
- **PWAフレンドリー**: Service Workerのキャッシュと異なり、IndexedDBは永続的
- **帯域効率**: 一度ダウンロードすれば再取得不要
- **Linux対応**: ローカルにCJKフォントがなくても美しい表示

---

## カスタム背景画像機能

### 概要

ユーザーが左右ペイン別々に背景画像を設定できる機能。テーマの背景色の上に、半透明の画像を重ねて表示する。サーバー側に画像を持たず、完全にクライアントサイド（IndexedDB）で保存・管理する。

### 技術実装

1. **読み込み**: FileReader APIでArrayBufferとして読み込み
2. **保存**: IndexedDBの`backgrounds`ストアに保存（キー: `custom-left` / `custom-right`）
3. **適用**: `::before`擬似要素でテーマ背景色の上に半透明画像を重ねる
4. **削除**: IndexedDBから削除し、もう片方のペインの背景を保持したまま再適用

### UI/UX

#### 設定画面のUI要素（左右2列レイアウト）

- **左ペイン設定エリア**:
  - **プレビューエリア**（画像設定時のみ表示）
    - 高さ: 120px
    - テーマの背景色 + 半透明の画像
    - 中央に「プレビュー」ラベル
    - 角丸8px
  - 「背景画像選択」ボタン
  - 「デフォルトに戻す」ボタン（設定時のみ表示）
  - **透明度スライダー**（画像設定時のみ表示）
    - ラベル「濃さ」と現在値（%）を上段に表示
    - スライダーを下段に配置（縦並びレイアウト）
    - 範囲: 5%〜50%（5%刻み）

- **右ペイン設定エリア**:
  - **プレビューエリア**（画像設定時のみ表示）
    - 高さ: 120px
    - テーマの背景色 + 半透明の画像
    - 中央に「プレビュー」ラベル
    - 角丸8px
  - 「背景画像選択」ボタン
  - 「デフォルトに戻す」ボタン（設定時のみ表示）
  - **透明度スライダー**（画像設定時のみ表示）
    - ラベル「濃さ」と現在値（%）を上段に表示
    - スライダーを下段に配置（縦並びレイアウト）
    - 範囲: 5%〜50%（5%刻み）

- **対応フォーマット表示**: `.jpg`, `.jpeg`, `.png`, `.webp`, `.gif`
- **アップロード状態表示**: アップロード中は「アップロード中...」と表示

#### 操作フロー

1. 設定画面を開く
2. 左ペイン（または右ペイン）の「背景画像選択」ボタンをクリック
3. 画像ファイルを選択
4. **即座に適用**（リロード不要）
5. **設定画面のプレビューエリアに画像が表示される**
   - 各ペインの設定エリア内に120px高さのプレビューボックスが表示
   - テーマの背景色の上に半透明で画像が重なる
   - 「プレビュー」ラベルが中央に表示
   - スクロールせずに見える位置に配置
6. **「濃さ」スライダーで透明度を調整**（5%〜50%）
7. 「デフォルトに戻す」で元に戻す（リロード不要、プレビューも消える）

### 仕様

- **同時保存数**: 左右それぞれ1つ（新しい画像は自動で上書き）
- **保存場所**: IndexedDB `backgrounds` オブジェクトストア
  - 左ペイン: キー `'custom-left'`
  - 右ペイン: キー `'custom-right'`
- **設定フラグ**: LocalStorageに以下を保存
  - `Settings.hasCustomBackgroundLeft` (boolean)
  - `Settings.hasCustomBackgroundRight` (boolean)
  - `Settings.backgroundOpacityLeft` (number, デフォルト: 0.1)
  - `Settings.backgroundOpacityRight` (number, デフォルト: 0.1)
- **適用範囲**:
  - 左ペイン: `.left-column .main-pane::before`
  - 右ペイン: `.right-column .main-pane::before`
  - 設定画面プレビュー:
    - 左ペイン: `.background-preview-left::after`
    - 右ペイン: `.background-preview-right::after`
- **透明度**: 0.05〜0.5（スライダーで調整可能、デフォルト: 0.1）
- **表示方式**: テーマの背景色の上に半透明の画像を重ねる
- **リロード**: 適用・削除ともにリロード不要
- **起動時復元**: フラグがtrueの場合、自動で適用

### 実装の詳細

**z-indexによる重ね順:**

| レイヤー | 要素                             | z-index |
| -------- | -------------------------------- | ------- |
| 下       | `.main-pane::before`（背景画像） | 0       |
| 中       | `.main-pane`（テーマ背景色）     | -       |
| 上       | `.main-pane > *`（コンテンツ）   | 1       |

CodeMirrorは独自の背景色を持つため、`!important`で強制的に透過させています。

### セキュリティ

- **拡張子チェック**: `.jpg`, `.jpeg`, `.png`, `.webp`, `.gif` のみ許可
- **Blobベース読み込み**: `URL.createObjectURL()`で安全に適用
- **クライアントサイド完結**: サーバーに画像ファイルをアップロードしない
- **XSS対策**: Blob URLを使用し、直接HTMLに挿入しない

---
