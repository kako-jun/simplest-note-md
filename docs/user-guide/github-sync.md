# GitHub連携

> AgasteerとGitHubの同期方法を説明します。

---

## 🔑 事前準備

GitHub連携を使うには、以下の準備が必要です。

1. **GitHubアカウント** - 持っていない場合は[GitHub](https://github.com/)で作成
2. **Personal Access Token** - [トークンの取得方法はこちら](../shared/github-token.md)
3. **GitHubリポジトリ** - ノートを保存するリポジトリを作成（Public/Private どちらでも可）

---

## ⚙️ GitHub連携の設定

### 設定画面での入力

1. 設定画面を開く（ヘッダー右上の⚙️アイコン）
2. GitHub連携セクションで以下を入力：

#### 必須項目

- **Personal Access Token**: GitHubで生成したトークンを入力
  - ?アイコンをクリックすると、取得方法の画像が表示されます
- **リポジトリ名**: `owner/repo`形式（例: `yamada/my-notes`）
  - ?アイコンをクリックすると、リポジトリ名の説明が表示されます

#### 自動設定項目

以下の項目は自動的に設定されます（変更も可能）：

- **コミットユーザー名**: GitHubのユーザー名
- **コミットメールアドレス**: GitHubのメールアドレス

### テスト実行

設定が正しいかテストできます。

1. 「Pushテスト」ボタンをクリック
2. GitHubにテストデータが送信されます
3. 成功すると「Push成功」とトースト通知が表示されます

---

## 💾 Pushの実行（GitHubへの保存）

ノートやリーフを編集したら、GitHubに保存（Push）できます。

### Pushの手順

1. ノートやリーフを編集
2. 💾ボタン（保存）をクリック
3. GitHub上の`notes/`ディレクトリに`.md`ファイルとして保存されます

### Push中の表示

- Push開始時に「Pushing...」とトースト通知が表示されます
- Push完了時に「Push成功」と表示されます
- エラー時は「Push失敗」と表示されます

### Pushの仕組み

Agasteerは**Git Tree API**を使用して一括Pushを行います。

- **SHA最適化**: 変更されていないファイルは転送しません
- **削除・リネーム対応**: ファイルの削除やリネームも自動的に反映されます
- **強制更新**: 個人用アプリのため、常に成功を優先します（`force: true`）

### Push並行実行防止

Push中は💾ボタンが無効化され、複数のPush処理が同時に実行されないようになっています。

---

## 📥 Pullの実行（GitHubからの取得）

GitHub上の最新データをIndexedDBに同期できます。

### Pullの実行方法

#### ヘッダーのPullボタン（推奨）

1. ヘッダー左側のアプリタイトル横にある⬇️ボタン（Pull）をクリック
2. GitHub上の最新データがIndexedDBに同期されます

**PWA版（ホーム画面からインストール）で特に便利です**。ブラウザ版ではリロードでもPullできますが、PWA版ではリロードボタンがないため、このPullボタンが重要な役割を果たします。

#### 設定画面からのPull

1. 設定画面を開く
2. 「Pullテスト」ボタンをクリック
3. GitHub上の最新データがIndexedDBに同期されます

### Pullの仕組み

初回Pull時は以下の流れで実行されます：

1. IndexedDBの全データを削除
2. GitHub上の`notes/`ディレクトリ内のすべての`.md`ファイルを取得
3. 取得したデータをIndexedDBに保存

---

## 🗂️ 保存先のパス構造

GitHub上では以下のようなディレクトリ構造でファイルが保存されます。

```
notes/
├── ノート1/
│   ├── リーフ1.md
│   ├── リーフ2.md
│   └── サブノート1/
│       ├── リーフ3.md
│       └── リーフ4.md
└── ノート2/
    └── リーフ5.md
```

### ファイル名のルール

- **ノート**: ディレクトリ名として保存
- **リーフ**: `.md`ファイルとして保存
- **ファイル名**: リーフのタイトルがファイル名になります

---

## ⚠️ 未保存変更の確認

Agasteerは未保存の変更を追跡し、データ損失を防ぎます。

### 未保存変更の表示

- 💾ボタン（保存）に赤い丸印（notification badge）が表示されます
- ノートやリーフを編集すると、自動的に表示されます
- Pushを実行すると、赤い丸印が消えます

### Pull実行時の確認

未保存の変更がある状態でPullを実行すると、確認ダイアログが表示されます。

- 「はい」: Pullを実行（未保存の変更は失われます）
- 「いいえ」: Pullをキャンセル（先にPushして保存してください）

### ページ離脱時の確認

未保存の変更がある状態で以下の操作を行うと、ブラウザ標準の確認ダイアログが表示されます。

- タブを閉じる
- ブラウザをリロード
- 別のページに移動

**注意**: アプリ内のナビゲーション（ノートやリーフの移動）では確認ダイアログは表示されません。これは自動保存が行われるためです。

---

## 📊 Push回数カウント

ホーム画面右下にPush回数が統計情報として表示されます。

### カウントの仕組み

- Pushを実行するたびにカウントが増加します
- カウントは`metadata.json`に保存されます
- GitHub上の`metadata.json`を編集することで、カウントをリセットできます

---

## 🔄 複数デバイスでの同期

Agasteerは複数デバイスでの同期に対応しています。

### 同期の手順

1. **デバイスA**でノートを編集し、Pushを実行
2. **デバイスB**でPullを実行し、最新データを取得
3. **デバイスB**で編集し、Pushを実行
4. **デバイスA**でPullを実行し、最新データを取得

### 注意事項

- **競合解決UIはまだ実装されていません**
- 複数デバイスで同時編集すると、後からPushしたデータで上書きされます
- 必ず、編集前にPullを実行してください

---

## 🛡️ セキュリティとプライバシー

### データの保存場所

- **GitHub Token**: ブラウザのLocalStorage（クリアテキスト）
- **ノート内容**: ブラウザのIndexedDB + GitHub（暗号化されたHTTPS通信）
- **設定情報**: ブラウザのLocalStorage

### 推奨事項

- ✅ 信頼できる個人端末でのみ使用する
- ✅ トークンには適切な有効期限を設定する
- ✅ 定期的にトークンをローテーションする
- ❌ 共用端末では使用しない
- ❌ トークンを他人と共有しない

### データのバックアップ

IndexedDBはブラウザのキャッシュクリアで消える可能性があります。重要なノートは：

- GitHub同期を実行してバックアップ
- ダウンロード機能でローカルに保存
- 定期的にブラウザのバックアップを取る

---

## 🎯 次のステップ

GitHub連携を理解したら、カスタマイズを学びましょう。

→ [カスタマイズ](./customization.md)

---

**関連ドキュメント**:

- [GitHub Personal Access Tokenの取得](../shared/github-token.md)
- [基本機能](./basic-features.md)
- [よくある質問（FAQ）](./faq.md)
