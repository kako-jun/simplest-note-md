# 拡張計画と既知の課題

SimplestNote.mdの将来的な拡張計画と既知の課題について説明します。

## 拡張の可能性

### 短期的な改善提案

1. **エクスポート/インポート機能**
   - JSONでのバックアップ/復元
   - 複数ノートの一括ダウンロード（ZIP形式）

2. **検索機能**
   - ノート名での検索
   - 全文検索（content内）
   - 正規表現対応

3. **キーボードショートカット**
   - `Ctrl+S`: GitHub保存
   - `Ctrl+N`: 新規ノート
   - `Ctrl+K`: クイック検索

4. **オフライン対応**
   - Service Workerでのキャッシュ
   - オフライン時の同期キュー

### 中期的な機能提案

1. **GitHub双方向同期**
   - GitHub→アプリの自動取得
   - 競合解決UI
   - 差分表示

2. **Markdown拡張**
   - タスクリスト（`- [ ]` / `- [x]`）
   - 数式サポート（KaTeX）
   - Mermaid図表対応

3. **タグシステム**
   - ノートへのタグ付け
   - タグでのフィルタリング
   - タグクラウド表示

4. **履歴管理**
   - ノート編集履歴の保存
   - 差分表示
   - 過去バージョンへの復元

5. **モバイル最適化**
   - スワイプジェスチャー
   - タッチ操作の改善
   - PWA対応

### 長期的なビジョン

1. **プラグインシステム**
   - カスタムコマンドの登録
   - エディタ拡張
   - テーマのプラグイン化

2. **他サービスとの連携**
   - GitLab API対応
   - Dropbox/OneDrive同期
   - WebDAV対応

3. **コラボレーション**
   - 共有リンク生成
   - リアルタイム共同編集（WebSocket）
   - コメント機能

4. **AI統合**
   - 文章校正
   - 自動要約
   - ノートの分類提案

---

## 既知の課題

### ~~メタデータの永続化問題~~ ✅ **解決済み（Version 4.3）**

**問題の内容:**

以前は、GitHubには**リーフのMarkdownファイルのみ**が保存されており、以下のメタデータが失われていました：

1. **ノート・リーフのID**
   - Pull時に新しいUUIDが割り当てられる
   - URLのクエリパラメータが無効になる
   - ブックマークやディープリンクが機能しない

2. **並び順（order）**
   - ユーザーがドラッグ&ドロップで並び替えても、Pull後に順序が失われる
   - ファイルシステムのアルファベット順で表示されてしまう

3. **ノート・リーフの親子関係**
   - ディレクトリ構造から推測するため、ノート名変更時に対応が難しい

**解決策（Version 4.3で実装）:**

`notes/metadata.json` を導入し、以下のメタ情報を永続化：

```json
{
  "version": 1,
  "pushCount": 42,
  "notes": {
    "仕事": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "order": 0
    }
  },
  "leaves": {
    "仕事/会議メモ.md": {
      "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "updatedAt": 1703000000000,
      "order": 0
    }
  }
}
```

**効果:**

- ✅ Pull後も並び順が保持される
- ✅ URLからの復元が正しく機能する
- ✅ ブックマークやディープリンクが永続的に有効
- ✅ Push回数などの統計情報も保存可能

### その他の既知の制約

1. **複数デバイスでの同時編集**
   - Last Write Winsの仕様（最後にPushしたデバイスが勝つ）
   - マージ機能なし

2. **Push失敗後のPullでデータ消失**
   - 仕様通りの動作だが、ユーザーにとって直感的でない可能性

3. **ネットワークエラー時の挙動**
   - Push失敗時、編集内容はIndexedDBに残るが、次のPullで消える
   - オフライン対応なし

---

## 次の実装計画

### URLルーティングの改善（計画中 2025-01-23）

#### 現状の課題

現在はクエリパラメータベースのURL（`?note=uuid&leaf=uuid`）を使用していますが、以下の問題があります：

1. **UUIDの不安定性**
   - Pull時に新しいUUIDが割り当てられるため、ブックマークやディープリンクが無効になる
   - GitHubにメタデータを保存していないため、IDが永続化されない

2. **URL の可読性**
   - UUIDはユーザーにとって意味のない文字列
   - URLから内容を推測できない

3. **2ペイン表示への対応不足**
   - 横長画面では2ペイン表示を実現したい（左右で別々のノート・リーフを表示）
   - 現在のURL設計では2つの状態を表現できない

#### 新しい設計方針

**2ペイン対応のクエリパラメータ設計**に移行し、ノート名・リーフ名のパスをURLに使用する：

```
# 現在（UUIDベース）
https://example.com/simplest-note-md?note=550e8400-e29b-41d4-a716-446655440000&leaf=7c9e6679-7425-40de-944b-e07fc1f90ae7

# 新設計（パス文字列ベース、2ペイン対応）
https://example.com/simplest-note-md?left=/仕事/会議&right=/仕事/会議/議事録
```

#### UI設計

**横長画面での2ペイン表示**:

```
┌─────────────────────────────────────────────────┐
│ Header                                          │
├─────────────────────────────────────────────────┤
│ Breadcrumbs (共通)                              │
├────────────────────┬────────────────────────────┤
│ Left Pane          │ Right Pane                 │
│                    │                            │
│ ノート・リーフ一覧  │ リーフ編集画面             │
│ (左側パス)          │ (右側パス)                 │
│                    │                            │
└────────────────────┴────────────────────────────┘
```

- パンくずリストより下が左右2つに分割
- 左右それぞれ独立して操作可能
- 縦長画面では1ペイン表示（従来通り）

#### 実装方針

1. **ファイル名の一意性制約**
   - 同じ階層に同じ名前のノート・リーフを作成できないようにする
   - 作成時にバリデーションを追加

2. **URLエンコーディング**
   - 日本語や特殊文字を含むパスをURLエンコード
   - `encodeURIComponent()` / `decodeURIComponent()` を使用

3. **パス解析**
   - クエリパラメータ `left` と `right` からパスを抽出
   - パス文字列（`/ノート名/サブノート名/リーフ名`）からノート・リーフを解決

4. **レスポンシブ対応**
   - URLは常に `left` と `right` の両方を持つ
   - 縦長画面では右ペインをCSSで非表示にするだけ
   - URLの構造は画面サイズに関わらず同じ

5. **ハッシュの使用禁止**
   - SPAルーティングでよく使われる `#` は使用しない
   - History APIを活用

#### URL例

```
# URLは常にダブルペイン形式
?left=/仕事&right=/仕事/会議/議事録    # 左:仕事ノート一覧、右:議事録編集
?left=/仕事/会議&right=/仕事/その他    # 左:会議サブノート、右:その他サブノート

# 縦長画面では右ペインがCSSで非表示になるだけで、URLは同じ
# 画面を回転させれば右ペインが見えるようになる
```

#### メリット

- ✅ **URLの永続性**: Pull後もノート名・リーフ名が変わらなければURLは有効
- ✅ **可読性**: URLから内容が推測できる
- ✅ **2ペイン対応**: 左右の状態を同時に保存・復元可能
- ✅ **ブックマーク対応**: 作業状態をそのままブックマーク
- ✅ **GitHubとの整合性**: パスがGitHubのディレクトリ構造と一致

#### 実装タスク

- [x] ノート・リーフ作成時の名前重複チェック（同一階層）
  - `generateUniqueName()` ヘルパー関数を実装
  - 「ノート」→「ノート2」→「ノート3」のように自動採番
- [x] URLクエリパース処理の実装（`left` / `right`）
  - 新形式: `?left=/path&right=/path`
  - 旧形式（UUID）との後方互換性を維持
- [x] パス文字列からノート・リーフを解決するロジック
  - `src/lib/routing.ts` を新規作成
  - `resolvePath()`: パス → ノート・リーフ
  - `buildPath()`: ノート・リーフ → パス
- [ ] 2ペイン表示のレイアウト実装（CSS Grid / Flexbox）
  - **次の実装ステップ**
  - main要素を左右2ペインに分割
  - 左右それぞれ独立したビューを表示
  - 状態変数: `rightNote`, `rightLeaf`, `rightView` を追加済み
- [ ] レスポンシブ対応（画面幅による1ペイン/2ペイン切り替え）
  - メディアクエリで画面幅を判定
  - 縦長画面では右ペインを `display: none`
  - `isDualPane` フラグで状態管理
- [ ] ブラウザ履歴の管理
  - 現在: `pushState` のみ実装済み
  - 追加: `popstate` イベントハンドラは実装済み
- [ ] エラーハンドリング（存在しないパスへのアクセス）
  - 現在: ホームまたは親ノートにフォールバック
  - 改善: 404エラー表示やトースト通知

#### 実装詳細メモ（2025-01-23）

**完了した実装（コミット: 22b41d1）**

1. **名前重複チェック**

   ```typescript
   // App.svelte
   function generateUniqueName(baseName: string, existingNames: string[]): string {
     let name = baseName
     let counter = 1
     while (existingNames.includes(name)) {
       counter++
       name = `${baseName}${counter}`
     }
     return name
   }
   ```

2. **パス解決ロジック**

   ```typescript
   // src/lib/routing.ts
   export function resolvePath(path: string, notes: Note[], leaves: Leaf[]): PathResolution
   export function buildPath(note: Note | null, leaf: Leaf | null, notes: Note[]): string
   ```

3. **URLルーティング**
   - 現在: 1ペインのみ（`left` を使用）
   - URL形式: `?left=/仕事/会議&right=/仕事/会議/議事録`
   - 右ペインは現在は左と同じ値を設定（将来の拡張用）

**次の実装ポイント: 2ペイン表示**

現在の課題:

- App.svelteの `<main>` が単一のビューのみ表示
- 左右2つのビューを同時に表示する必要がある
- 各ペインが独立した状態を持つ

実装方針:

```svelte
<main class="dual-pane-container">
  <div class="left-pane">
    <!-- 左ペインのビュー -->
  </div>
  <div class="right-pane">
    <!-- 右ペインのビュー -->
  </div>
</main>
```

CSS:

```css
.dual-pane-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

@media (max-width: 768px) {
  .dual-pane-container {
    grid-template-columns: 1fr;
  }
  .right-pane {
    display: none;
  }
}
```
