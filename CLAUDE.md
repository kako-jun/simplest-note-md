# SimplestNote.md - 開発者向けドキュメント

> このドキュメントは、SimplestNote.mdの全体像を把握するための目次とプロジェクト進捗管理を提供します。
> 詳細なドキュメントは[docs/](./docs/)ディレクトリに分割して配置されています。

---

## 📚 ドキュメント目次

### 基本設計

- **[アーキテクチャ](./docs/architecture.md)**
  - アーキテクチャ概要と設計哲学
  - 技術スタック（Svelte, TypeScript, Vite, CodeMirror）
  - プロジェクト構造とファイル構成
  - コードアーキテクチャとレイヤー構造

- **[データモデルと状態管理](./docs/data-model.md)**
  - TypeScript型定義（Settings, Folder, Note, View）
  - データの一意性とリレーション
  - 状態管理とデータフロー
  - CRUD操作のパターン

### 機能実装

- **[主要機能の実装](./docs/features.md)**
  - エディタ管理（CodeMirror統合）
  - パンくずナビゲーション
  - モーダルシステム

- **[GitHub API統合](./docs/github-integration.md)**
  - 認証とファイルパス構築
  - 既存ファイルのSHA取得
  - ファイル保存とBase64エンコーディング

- **[データ永続化とストレージ](./docs/storage.md)**
  - LocalStorage（設定情報）
  - IndexedDB（ノート・リーフデータ）
  - GitHub（リモートリポジトリ）
  - テーマシステム

### 開発・運用

- **[実装されたリファクタリング](./docs/refactoring.md)**
  - コンポーネント分割の経緯
  - 状態管理の改善（Svelteストア導入）
  - ビジネスロジックの分離
  - モジュール分離の完了（sync.ts, ui.ts, Toast.svelte）

- **[開発ガイド](./docs/development.md)**
  - 開発ワークフロー
  - パフォーマンス最適化
  - セキュリティ考慮事項
  - トラブルシューティング

- **[拡張計画と既知の課題](./docs/future-plans.md)**
  - 短期・中期・長期的な拡張計画
  - 既知の課題（メタデータの永続化問題）
  - 次の実装計画（2ペイン表示、パスベースURLルーティング）

---

## 🎯 現在の進捗状況

### ✅ 完了した実装（2025-01-23時点）

#### コンポーネント分割とモジュール化

- [x] 1,373行の単一ファイルから15ファイルへの分割
- [x] レイアウトコンポーネント（Header, Breadcrumbs, Modal）
- [x] ビューコンポーネント（Home, Folder, Editor, Settings）
- [x] エディタコンポーネント（MarkdownEditor）
- [x] ビジネスロジック層（stores, github, storage, theme, types）

#### 状態管理とデータフロー

- [x] Svelteストアの導入（writable, derived）
- [x] グローバル状態の一元管理
- [x] データ永続化仕様の明確化（GitHub SSoT設計）
- [x] LocalStorage（設定のみ）とIndexedDB（ノート・リーフ）の分離
- [x] **ノート階層制限**（ルートノート→サブノートの2階層まで）

#### UI/UX改善

- [x] 設定画面のモーダル化
- [x] URLルーティング（パスベース）の実装（1ペイン版）
- [x] ブラウザ履歴対応（戻る/進むボタン）
- [x] トースト通知（Push/Pull開始時）
- [x] テーマボタンのスマホ対応（3個ずつ2段表示）
- [x] **2ペイン表示**（アスペクト比判定: 横 > 縦で2ペイン表示）
- [x] **レスポンシブ対応**（スマホ横向きで2ペイン表示に自動切替）
- [x] **リーフのタイトルと#見出しの双方向同期**（# のみ対応、新規リーフは初期コンテンツ設定）
- [x] **左右ペイン独立編集**（EditorViewを左右対等に実装、leafIdベース更新）
- [x] **2ペイン表示での同期**（同じリーフを左右で開いている場合は即座に同期）
- [x] **マークダウンプレビュー機能**（marked + DOMPurify、編集/プレビュートグル、URLルーティング対応）

#### GitHub同期

- [x] Push/Pull処理の分離（sync.ts）
- [x] トースト状態管理（ui.ts）
- [x] 初回Pull時のIndexedDB全削除→全作成フロー
- [x] **Git Tree APIによる一括Push**（削除・リネーム対応、APIリクエスト数削減）
- [x] **SHA最適化**（変更されていないファイルは転送しない）
- [x] **Push並行実行防止**（isPushingフラグ）
- [x] **強制更新**（force: true、個人用アプリなので常に成功を優先）

#### データ保護

- [x] **未保存変更の確認機能**
  - isDirtyストアでGitHubにPushされていない変更を追跡
  - Pull実行時に確認ダイアログを表示
  - ページ離脱時（タブを閉じる、リロード）にブラウザ標準ダイアログを表示
  - 保存ボタンに赤い丸印（notification badge）を表示
  - アプリ内ナビゲーションは制限されない（自動保存のため）

### 🚧 実装中の機能

なし（現在、すべての計画済み機能が実装完了）

### 📋 今後の実装予定

#### 短期的な改善

- [ ] エクスポート/インポート機能（JSON, ZIP）
- [ ] 検索機能（ノート名、全文検索、正規表現）
- [ ] キーボードショートカット
- [ ] オフライン対応（Service Worker）

#### 中期的な機能

- [ ] GitHub双方向同期（自動Pull、競合解決UI）
- [ ] Markdown拡張（タスクリスト、数式、Mermaid）
- [ ] タグシステム
- [ ] 履歴管理（編集履歴、差分表示）
- [ ] モバイル最適化（PWA対応）

#### 長期的なビジョン

- [ ] プラグインシステム
- [ ] 他サービスとの連携（GitLab, Dropbox, OneDrive）
- [ ] コラボレーション（共有リンク、リアルタイム編集）
- [ ] AI統合（文章校正、自動要約）

---

## 🔧 クイックリファレンス

### 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# 型チェック（ウォッチモード）
npm run check -- --watch

# フォーマットチェック
npm run format:check

# リント（フォーマット + 型チェック）
npm run lint

# 本番ビルド
npm run build

# ビルド結果確認
npm run preview
```

### プロジェクト統計

- **総行数**: 約2,400行（コメント・空行含む）
- **コンポーネント数**: 9個
- **libモジュール数**: 7個
- **ドキュメント数**: 8個（このファイル含む）

### 主要技術

| 技術           | バージョン | 役割                                |
| -------------- | ---------- | ----------------------------------- |
| **Svelte**     | 4.2.19     | リアクティブUIフレームワーク        |
| **TypeScript** | 5.7.2      | 型安全性の提供                      |
| **Vite**       | 5.4.10     | ビルドツール & 開発サーバー         |
| **CodeMirror** | 6.0.1      | 高機能エディタ                      |
| **marked**     | 12+        | マークダウン→HTML変換（プレビュー） |
| **DOMPurify**  | 3+         | XSSサニタイゼーション               |

---

## 📝 変更履歴

### Version 4.5 (2025-01-23)

- **マークダウンプレビュー機能の実装**
  - `marked` + `DOMPurify`によるセキュアなHTMLレンダリング
  - 編集/プレビュートグルボタン（保存ボタンの左隣に配置）
  - プレビュー中は読み取り専用（編集不可）
  - URLルーティング対応（`:preview`サフィックス）
  - 左右ペイン独立でプレビュー/編集を切り替え可能
  - PreviewView.svelteコンポーネントを追加
  - View型に`'preview'`を追加
  - routing.tsにプレビュー状態の永続化機能を追加
  - 全テーマ対応のプレビュースタイリング

### Version 4.4 (2025-01-23)

- **未保存変更の確認機能**
  - isDirtyストアを追加（GitHubにPushされていない変更を追跡）
  - エディタ編集時、ノート/リーフの作成・削除・変更時にisDirty.set(true)
  - Push成功時とPull成功時にisDirty.set(false)
  - Pull実行時に未保存の変更がある場合、確認ダイアログを表示（Modal.svelte）
  - ページ離脱時（タブを閉じる、リロード）にブラウザ標準の確認ダイアログを表示（beforeunload）
  - 保存ボタンに赤い丸印（notification badge）を表示
  - アプリ内ナビゲーション（ホーム、ノート、リーフ間の移動）は制限されない
  - ブラウザの戻る/進むボタンも制限されない
  - 自動保存（IndexedDB）により、アプリ内でのデータ損失は発生しない

### Version 4.3 (2025-01-23)

- **Push回数カウント機能の実装**
  - metadata.jsonにpushCountフィールドを追加
  - Push時に自動的にカウントをインクリメント
  - ホーム画面右下にPush回数を統計情報として表示
  - 半透明でノート・リーフカードの背面に配置
  - 古いmetadata.jsonとの後方互換性を確保（pushCountがない場合は0にフォールバック）
- **Pull/Push中のローディング表示**
  - 各ペインの中央にパルス動作する3つのドットを表示
  - 半透明の背景でコンテンツを覆う
  - Pull/Push完了後に自動的に非表示
- **GitHub APIキャッシュ問題の発見と解決**
  - Push回数カウント機能の実装中にGitHub Contents APIのキャッシュ問題を発見
  - `fetchGitHubContents`ヘルパー関数を作成しキャッシュバスターを一元管理
  - すべてのContents API呼び出しにタイムスタンプを付与（`?t=${Date.now()}`）
  - Push直後のPullでも最新データを取得できるように修正
  - これまで潜在的に存在していたデータ同期の問題を完全解決

### Version 4.2 (2025-01-23)

- **リーフのタイトルと#見出しの双方向同期**
  - 1行目が `# 見出し` の場合、リーフタイトルを自動更新
  - パンくずリストでタイトル変更時、1行目の見出しも自動更新
  - `## 見出し2` などには適用せず、`# 見出し` のみ対応
- **新規リーフの初期コンテンツ**
  - `# リーフ名` + 2行改行を自動設定
- **左右ペイン独立編集の実装**
  - EditorViewを左右対等に修正（leafIdパラメータを追加）
  - updateLeafContent/deleteLeaf/downloadLeafをleafIdベースに変更
  - $currentLeafへのハードコーディングを解消
- **2ペイン表示での同期**
  - 同じリーフを左右で開いている場合、編集が即座に両方に反映

### Version 4.1 (2025-01-24)

- **2ペイン表示の完全実装**
  - アスペクト比判定（横 > 縦）による自動切替
  - スマホ横向きで2ペイン表示に対応
  - 左右独立したナビゲーションとビュー表示
- **ノート階層制限の実装**
  - ルートノート→サブノートの2階層まで制限
  - createNote関数に階層深さチェックを追加
  - NoteViewのcanHaveSubNoteをリアクティブ宣言に修正（遷移時の誤判定を解消）

### Version 4.0 (2025-01-23)

- **ドキュメント整理**: CLAUDE.mdを目次と進捗管理に特化
- **docs/ディレクトリ**: 詳細ドキュメントを8ファイルに分割
  - architecture.md - アーキテクチャ概要
  - data-model.md - データモデルと状態管理
  - features.md - 主要機能の実装
  - github-integration.md - GitHub API統合
  - storage.md - データ永続化とストレージ
  - refactoring.md - 実装されたリファクタリング
  - development.md - 開発ガイド
  - future-plans.md - 拡張計画と既知の課題

### Version 3.0 (2025-01-23)

- モジュール分離の完了（sync.ts、ui.ts、Toast.svelte追加）
- データ永続化仕様の明確化（GitHub SSoT設計）
- UI改善（設定モーダル化、URLルーティング、トースト通知）
- 次の実装計画の追加（パスベースURLルーティング）

---

## 📞 サポート

- **リポジトリ**: [simplest-note-md](https://github.com/ariori/simplest-note-md)
- **デプロイ**: GitHub Pages（自動デプロイ）
- **CI/CD**: GitHub Actions

---

**Document Version**: 4.5
**Last Updated**: 2025-01-23
**Author**: Claude (Anthropic)
